(function(){tinymce.create("org.olat.ims.qti21.ui.editor",{getInfo:function(){return{longname:"OpenOLATQTI",author:"frentix GmbH",authorurl:"http://www.frentix.com",infourl:"http://www.frentix.com",version:"1.3.1"}},createControl:function(b,a){return null},init:function(f,e){var d=f.$,u=f.selection;var v,r;var g;var k,l;function q(){if(v){return v}var w=o_getMainWin();if(w){v=jQuery(document).ooTranslator().getTranslator(w.o_info.locale,"org.olat.ims.qti21.ui.editor")}else{v={translate:function(x){return x}}}return v}function c(){if(r){return r}var w=o_getMainWin();if(w){r=jQuery(document).ooTranslator().getTranslator(w.o_info.locale,"org.olat.core")}else{r={translate:function(x){return x}}}return r}function i(w){h(w,"string")}function o(w){h(w,"float")}function h(B,E){var F=f.getParam("ffxhrevent");if(typeof k!="undefined"){var x=jQuery(k).closest("span[data-qti='textentryinteraction']");var G=x.attr("data-qti-response-identifier");var C=jQuery(x).children().html();var y=(C==""||C=="&nbsp;"?"true":"false");o_ffXHREvent(F.formNam,F.dispIdField,F.dispId,F.eventIdField,2,false,false,false,"_csrf",F.csrf,"cmd","gapentry","responseIdentifier",G,"selectedText",C,"emptySolution",y,"newEntry",false)}else{var w=1;var A=f.selection.getContent({format:"text"});tinymce.each(f.dom.select("span[data-qti]"),function(I){var H=jQuery(I).attr("data-qti-response-identifier");if(H.lastIndexOf("RESPONSE_",0)==0){var J=parseInt(H.substring(9,H.length));if(J>w){w=J}}});var G="RESPONSE_"+(w+1);if(typeof A==="undefined"||A.length==0){if(E==="float"){A="42.0"}else{A="gap"}}var D=n(G,A,"textentryinteraction",E);var z=new tinymce.html.Serializer().serialize(D);f.insertContent(z);o_ffXHREvent(F.formNam,F.dispIdField,F.dispId,F.eventIdField,2,false,false,false,"_csrf",F.csrf,"cmd","gapentry","responseIdentifier",G,"newEntry",true,"selectedText",A,"gapType",E)}f.setDirty(true)}function m(){function w(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return w()+w()+w()+w()+w()+w()+w()}function b(A){var E;if(typeof l!="undefined"){E=jQuery(l).data("data-identifier")}else{var w=1;var x=f.selection.getContent({format:"text"});var D=false;if(x==null||x.length==0){x="text";D=true}var B="ht"+m();var C=t(B,x,false,"hottext");var y=new tinymce.html.Serializer().serialize(C);f.insertContent(y);if(D){var z=f.dom.select("span[data-qti-identifier="+B+"] span[contenteditable=true]");f.selection.select(z[0],true)}jQuery("span.hottext[data-qti-identifier='"+B+"'] a",f.getBody()).each(function(F,G){p(G)})}}f.addButton("olatqtifibtext",{title:q().translate("new.fib"),icon:"gaptext",stateSelector:["span[data-qti-gap-type=string]"],onclick:i});f.addButton("olatqtifibnumerical",{title:q().translate("new.fib")+" Numerical",icon:"gapnumerical",stateSelector:["span[data-qti-gap-type=float]"],onclick:o});f.addButton("olatqtihottext",{title:q().translate("new.hottext"),icon:"hottext",stateSelector:["span[data-qti=hottext]"],onclick:b});f.addButton("editgap",{title:"edit",icon:"edit",onclick:h});f.addMenuItem("olatqtifibtext",{text:q().translate("new.fib"),icon:"gapnumerical",stateSelector:["span[data-qti-gap-type=string]"],onclick:o});f.addMenuItem("olatqtifibnumerical",{text:q().translate("new.fib.numerical")+" Numerical",icon:"gaptext",stateSelector:["span[data-qti-gap-type=float]"],onclick:i});f.addMenuItem("olatqtihottext",{text:q().translate("new.hottext"),icon:"hottext",stateSelector:["span[data-qti=hottext]"],onclick:b});f.on("NodeChange",function(w){if(k&&k.id!=w.element.src){k=undefined}if(l&&l.id!=w.element.src){l=undefined}if(f.dom.is(w.element,"span[data-qti=textentryinteraction]")){k=w.element}else{if(jQuery(w.element).parent("span[data-qti='textentryinteraction']").length>0){k=w.element}}if(jQuery(w.element).parent("span.hottext").length>0){l=w.element}jQuery(w.element).parent("span[data-qti-gap-type=float]").each(function(y,z){if(jQuery(w.element).prop("tagName").toLowerCase()=="span"){var x=jQuery(w.element).text();if(!jQuery.isNumeric(x)){jQuery(z).addClass("error")}else{jQuery(z).removeClass("error")}}});jQuery("span.hottext[data-copy='needlistener']",w.element).each(function(x,y){if(jQuery("a.o_check",y).length==0){var z=jQuery(y).attr("data-qti-checked");jQuery(y).prepend("<a class='o_check "+("true"==z?"checked":"")+"' contenteditable='false'><i contenteditable='false'> </i></a>")}if(jQuery("span[contenteditable='true']",y).text()=="x-y-x"&&jQuery(y).attr("data-qti-empty")=="true"){jQuery("span[contenteditable='true']",y).text("");jQuery(y).attr("data-qti-empty","false")}jQuery("a.o_check",jQuery(y)).each(function(B,D){var E=jQuery._data(D,"events");if(E&&E.click){}else{p(D);if(jQuery(D).hasClass("checked")){var A=f.getParam("ffxhrevent");var C=jQuery(y).data("qti-identifier");o_ffXHRNFEvent(A.formNam,A.dispIdField,A.dispId,A.eventIdField,2,"_csrf",A.csrf,"cmd","hottext","identifier",C,"correct","true")}}})});jQuery("span.textentryinteraction[data-copy='needlistener']",w.element).each(function(x,y){if(jQuery("a.o_ops",y).length==0){jQuery(y).append("<a class='o_ops' contenteditable='false'><i contenteditable='false'> </i></a>")}if(jQuery("span[contenteditable='true']",y).text()=="x-y-x"&&jQuery(y).attr("data-qti-empty")=="true"){jQuery("span[contenteditable='true']",y).text("");jQuery(y).attr("data-qti-empty","false")}jQuery("a.o_ops",jQuery(y)).each(function(z,A){var B=jQuery._data(A,"events");if(B&&B.click){}else{s(y)}})})});function n(H,B,E,F){var D=new tinymce.html.Node("span",1);D.attr({id:H,"data-qti":E,"data-qti-response-identifier":H,"data-qti-solution":B,"data-qti-gap-type":F,"data-mce-placeholder":"","data-textentryinteraction":"empty","class":E,contenteditable:"false"});var z=f.getParam("readonly");var x=z=="1"?"false":"true";var C=new tinymce.html.Node("span",1);C.attr({contenteditable:x});var y=new tinymce.html.Node("#text",3);y.raw=true;var I=jQuery("<div>").text(B).html();y.value=I;C.append(y);D.append(C);var A=new tinymce.html.Node("a",1);A.attr({contenteditable:"false","class":"o_ops"});var w=new tinymce.html.Node("i",1);w.attr({contenteditable:"false"});var G=new tinymce.html.Node("#text",3);G.raw=true;G.value="&nbsp;";w.append(G);A.append(w);D.append(A);return D}function t(E,D,F,J){var I=new tinymce.html.Node("span",1);I.attr({"data-qti":J,"data-qti-identifier":E,"data-qti-checked":(F?"true":"false"),"class":J,contenteditable:"false"});var B=f.getParam("readonly");var x=B=="1"?"false":"true";var H=new tinymce.html.Node("a",1);H.attr({contenteditable:"false","class":"o_check "+(F?"checked":"")});var w=new tinymce.html.Node("i",1);w.attr({contenteditable:"false"});var K=new tinymce.html.Node("#text",3);K.raw=true;K.value="&nbsp;";w.append(K);H.append(w);I.append(H);var G=new tinymce.html.Node("span",1);G.attr({contenteditable:x});if(typeof D==="string"){var z=new tinymce.html.Node("#text",3);z.raw=true;z.value=D;G.append(z)}else{var y,C=[];for(y=D.firstChild;y;y=y.walk()){if(y.parent==D){C.push(y)}if(y==D.lastChild){break}}for(var A=0;A<C.length;A++){G.append(C[A])}}I.append(G);return I}function p(w){jQuery(w).click(function(){var x=f.getParam("ffxhrevent");var z=jQuery(w);var y=z.parent("span.hottext").data("qti-identifier");o_ffXHRNFEvent(x.formNam,x.dispIdField,x.dispId,x.eventIdField,2,"_csrf",x.csrf,"cmd","hottext","identifier",y,"correct",z.hasClass("checked")?"false":"true");if(z.hasClass("checked")){z.removeClass("checked");z.parent("span.hottext").attr("data-qti-checked","false")}else{z.addClass("checked");z.parent("span.hottext").attr("data-qti-checked","true")}f.setDirty(true)})}function s(w){jQuery("a.o_ops",w).click(function(){var z=f.getParam("ffxhrevent");var y=jQuery(w).attr("data-qti-response-identifier");var x=jQuery(w).children().html();var A=(x==""||x=="&nbsp;"?"true":"false");o_ffXHREvent(z.formNam,z.dispIdField,z.dispId,z.eventIdField,2,false,false,false,"_csrf",z.csrf,"cmd","gapentry","responseIdentifier",y,"selectedText",x,"emptySolution",A);f.setDirty(true)})}function j(x){var w="";var z=new tinymce.dom.TreeWalker(x);var y;while((y=z.next())){if(y.type==3){if(w.length>0){w+=" "}w+=y.value}else{if(y.nodeType==3){if(w.length>0){w+=" "}w+=y.nodeValue}}}return w}function a(y){var w=false;var z='<div id="'+m()+'">'+y+"</div>";var A=jQuery(z);jQuery(A).find("span[data-qti='hottext']").each(function(B,D){var C="ht"+m();jQuery(D).attr("data-qti-identifier",C);jQuery(D).attr("data-copy","needlistener");jQuery(D).attr("data-copy-empty","false");var E=jQuery("span[contenteditable='true']",D).text();if(E==null||E.length==0){jQuery("span[contenteditable='true']",D).text("x-y-x");jQuery(D).attr("data-copy-empty","true")}w=true});jQuery(A).find("span[data-qti='textentryinteraction']").each(function(E,G){var F="te"+m();jQuery(G).attr("data-qti-response-identifier",F);jQuery(G).attr("data-copy","needlistener");jQuery(G).attr("data-copy-empty","false");var C=jQuery(G).attr("data-qti-gap-type");var B=jQuery(G).attr("data-qti-solution");var D=f.getParam("ffxhrevent");o_ffXHRNFEvent(D.formNam,D.dispIdField,D.dispId,D.eventIdField,2,"_csrf",D.csrf,"cmd","copy-gapentry","responseIdentifier",F,"newEntry",true,"selectedText",B,"gapType",C);jQuery("a.o_ops",G).append(jQuery("<i class='visible'>&nbsp;</i>"));var H=jQuery("span[contenteditable='true']",G).text();if(H==null||H.length==0){jQuery("span[contenteditable='true']",G).text("x-y-x");jQuery(G).attr("data-copy-empty","true")}w=true});var x=new Object();x.replace=w;x.htmlContent=A;return x}f.addCommand("qtiUpdateTextEntry",function(z,y){var x=y.responseIdentifier;var w=y["data-qti-solution"];jQuery("span[data-qti-response-identifier='"+x+"']>span",f.getBody()).each(function(A,B){jQuery(B).text(w)});jQuery("span[data-qti-response-identifier='"+x+"']",f.getBody()).each(function(A,B){s(jQuery(B))})});f.on("init",function(){if(f.settings.content_css!==false){f.dom.loadCSS(e+"/css/content.css")}jQuery(".textentryinteraction",f.getBody()).each(function(w,x){s(x)});jQuery("span.hottext a.o_check",f.getBody()).each(function(w,x){p(x)})});f.on("preInit",function(){f.parser.addNodeFilter("textentryinteraction,hottext",function(w){var z=w.length,x,F,A;while(z--){x=w[z];if(x.name=="textentryinteraction"){var H=x.attr("responseidentifier");var G=x.attr("openolattype");var E=x.attr("data-qti-solution");if(typeof E==="undefined"){E="&nbsp;"}if(typeof G==="undefined"){G="string"}var F=n(H,E,"textentryinteraction",G);x.replace(F)}else{if(x.name=="hottext"){var D=x.attr("identifier");var y=f.getParam("correctHottexts");var C=jQuery.inArray(D,y)>=0;var B=x;var F=t(D,B,C,"hottext","hottext");x.replace(F)}}}})});f.on("PreProcess",function(w){tinymce.each(f.dom.select("span[data-qti=textentryinteraction]"),function(z){var y=jQuery(z).attr("data-qti-response-identifier");var x=jQuery(z).children().text();var B=f.dom.create("textEntryInteraction",{responseIdentifier:y,"data-qti-solution":x,"data-qti-solution-empty":(x==""||x=="&nbsp;"?"true":"false")});var A=z.previousSibling==null&&(z.nextSibling==null||jQuery(z.nextSibling).attr("type")=="_moz"||jQuery(z.nextSibling).attr("data-mce-bogus")=="1");f.dom.replace(B,z,false);if(A){jQuery(B).after(String.fromCharCode(160))}});tinymce.each(f.dom.select("span[data-qti=hottext]"),function(A){var y=jQuery(A).data("qti-identifier");var x=f.dom.create("hottext",{identifier:y});var z=jQuery('span[contenteditable="true"]',A);jQuery(x).append(z.contents());f.dom.replace(x,A,false)})});f.on("newcell",function(x){var w=a(x.node.innerHTML);if(w.replace){x.node.innerHTML=jQuery(w.htmlContent).html()}});f.on("PastePreProcess",function(z){var x=f.selection.getNode();if(x!=null&&(jQuery(x).parent("span.hottext").length>0||jQuery(x).parent("span.textentryinteraction").length>0)){var y='<div id="'+m()+'">'+z.content+"</div>";var A=jQuery(y);z.content=jQuery(A).text();return}var w=a(z.content);if(w.replace){z.content=jQuery(w.htmlContent).html()}})}});tinymce.PluginManager.add("olatqti",org.olat.ims.qti21.ui.editor)})();