(function(){tinymce.create("org.olat.ims.qti21.ui.editor",{getInfo:function(){return{longname:"OpenOLATQTI",author:"frentix GmbH",authorurl:"http://www.frentix.com",infourl:"http://www.frentix.com",version:"1.3.3"}},createControl:function(b,a){return null},init:function(g,f){var e=g.$,w=g.selection;var x,t;var h;var l;var m;var r=0;function s(){if(x){return x}var y=o_getMainWin();if(y){x=jQuery(document).ooTranslator().getTranslator(y.o_info.locale,"org.olat.ims.qti21.ui.editor")}else{x={translate:function(z){return z}}}return x}function d(){if(t){return t}var y=o_getMainWin();if(y){t=jQuery(document).ooTranslator().getTranslator(y.o_info.locale,"org.olat.core")}else{t={translate:function(z){return z}}}return t}function j(y){i(y,"string")}function p(y){i(y,"float")}function i(E,H){var I=g.getParam("ffxhrevent");if(typeof l!="undefined"){var z=jQuery(l).closest("span[data-qti='textentryinteraction']");var J=z.attr("data-qti-response-identifier");var F=jQuery(z).children().html();var A=(F==""||F=="&nbsp;"?"true":"false");o_ffXHREvent(I.formNam,I.dispIdField,I.dispId,I.eventIdField,2,false,false,false,"_csrf",I.csrf,"cmd","gapentry","responseIdentifier",J,"selectedText",F,"emptySolution",A,"newEntry",false)}else{var y=1;var D=g.selection.getContent({format:"text"});tinymce.each(g.dom.select("span[data-qti]"),function(L){var K=jQuery(L).attr("data-qti-response-identifier");if(K.lastIndexOf("RESPONSE_",0)==0){var M=parseInt(K.substring(9,K.length));if(M>y){y=M}}});var C=(y+1);if(C<r){C=r+1;r=C}else{if(C>r){r=C}}var J="RESPONSE_"+C;if(typeof D==="undefined"||D.length==0){if(H==="float"){D="42.0"}else{D="gap"}}var G=o(J,D,"textentryinteraction",H);var B=new tinymce.html.Serializer().serialize(G);g.insertContent(B);o_ffXHREvent(I.formNam,I.dispIdField,I.dispId,I.eventIdField,2,false,false,false,"_csrf",I.csrf,"cmd","gapentry","responseIdentifier",J,"newEntry",true,"selectedText",D,"gapType",H)}g.setDirty(true)}function b(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function n(){return b()+b()+b()+b()+b()+b()+b()}function c(C){var G;if(typeof m!="undefined"){G=jQuery(m).data("data-identifier")}else{var y=1;var z=g.selection.getContent({format:"text"});var F=false;if(z==null||z.length==0){z="text";F=true}var D="ht"+n();var E=v(D,z,false,"hottext");var A=new tinymce.html.Serializer().serialize(E);g.insertContent(A);if(F){var B=g.dom.select("span[data-qti-identifier="+D+"] span[contenteditable=true]");g.selection.select(B[0],true)}jQuery("span.hottext[data-qti-identifier='"+D+"'] a",g.getBody()).each(function(H,I){q(I)})}}g.addButton("olatqtifibtext",{title:s().translate("new.fib"),icon:"gaptext",stateSelector:["span[data-qti-gap-type=string]"],onclick:j});g.addButton("olatqtifibnumerical",{title:s().translate("new.fib")+" Numerical",icon:"gapnumerical",stateSelector:["span[data-qti-gap-type=float]"],onclick:p});g.addButton("olatqtihottext",{title:s().translate("new.hottext"),icon:"hottext",stateSelector:["span[data-qti=hottext]"],onclick:c});g.addMenuItem("olatqtifibtext",{text:s().translate("new.fib"),icon:"gapnumerical",stateSelector:["span[data-qti-gap-type=string]"],onclick:p});g.addMenuItem("olatqtifibnumerical",{text:s().translate("new.fib.numerical")+" Numerical",icon:"gaptext",stateSelector:["span[data-qti-gap-type=float]"],onclick:j});g.addMenuItem("olatqtihottext",{text:s().translate("new.hottext"),icon:"hottext",stateSelector:["span[data-qti=hottext]"],onclick:c});g.on("NodeChange",function(y){if(l&&l.id!=y.element.src){l=undefined}if(m&&m.id!=y.element.src){m=undefined}if(g.dom.is(y.element,"span[data-qti=textentryinteraction]")){l=y.element}else{if(jQuery(y.element).parent("span[data-qti='textentryinteraction']").length>0){l=y.element}}if(jQuery(y.element).parent("span.hottext").length>0){m=y.element}jQuery(y.element).parent("span[data-qti-gap-type=float]").each(function(A,B){if(jQuery(y.element).prop("tagName").toLowerCase()=="span"){var z=jQuery(y.element).text();if(!jQuery.isNumeric(z)){jQuery(B).addClass("error")}else{jQuery(B).removeClass("error")}}});jQuery("span.hottext[data-copy='needlistener']",y.element).each(function(z,A){if(jQuery("a.o_check",A).length==0){var B=jQuery(A).attr("data-qti-checked");jQuery(A).prepend("<a class='o_check "+("true"==B?"checked":"")+"' contenteditable='false'><i contenteditable='false'> </i></a>")}if(jQuery("span[contenteditable='true']",A).text()=="x-y-x"&&jQuery(A).attr("data-qti-empty")=="true"){jQuery("span[contenteditable='true']",A).text("");jQuery(A).attr("data-qti-empty","false")}jQuery("a.o_check",jQuery(A)).each(function(D,F){var G=jQuery._data(F,"events");if(G&&G.click){}else{q(F);if(jQuery(F).hasClass("checked")){var C=g.getParam("ffxhrevent");var E=jQuery(A).data("qti-identifier");o_ffXHRNFEvent(C.formNam,C.dispIdField,C.dispId,C.eventIdField,2,"_csrf",C.csrf,"cmd","hottext","identifier",E,"correct","true")}}})});jQuery("span.textentryinteraction[data-copy='needlistener']",y.element).each(function(z,A){if(jQuery("a.o_ops",A).length==0){jQuery(A).append("<a class='o_ops' contenteditable='false'><i contenteditable='false'> </i></a>")}if(jQuery("span[contenteditable='true']",A).text()=="x-y-x"&&jQuery(A).attr("data-qti-empty")=="true"){jQuery("span[contenteditable='true']",A).text("");jQuery(A).attr("data-qti-empty","false")}jQuery("a.o_ops",jQuery(A)).each(function(B,C){var D=jQuery._data(C,"events");if(D&&D.click){}else{u(A)}})})});function o(J,D,G,H){var F=new tinymce.html.Node("span",1);F.attr({id:J,"data-qti":G,"data-qti-response-identifier":J,"data-qti-solution":D,"data-qti-gap-type":H,"data-mce-placeholder":"","data-textentryinteraction":"empty","class":G,contenteditable:"false"});var B=g.getParam("readonly");var z=B=="1"?"false":"true";var E=new tinymce.html.Node("span",1);E.attr({contenteditable:z});var A=new tinymce.html.Node("#text",3);A.raw=true;var K=jQuery("<div>").text(D).html();A.value=K;E.append(A);F.append(E);var C=new tinymce.html.Node("a",1);C.attr({contenteditable:"false","class":"o_ops"});var y=new tinymce.html.Node("i",1);y.attr({contenteditable:"false"});var I=new tinymce.html.Node("#text",3);I.raw=true;I.value="&nbsp;";y.append(I);C.append(y);F.append(C);return F}function v(G,F,H,L){var K=new tinymce.html.Node("span",1);K.attr({"data-qti":L,"data-qti-identifier":G,"data-qti-checked":(H?"true":"false"),"class":L,contenteditable:"false"});var D=g.getParam("readonly");var z=D=="1"?"false":"true";var J=new tinymce.html.Node("a",1);J.attr({contenteditable:"false","class":"o_check "+(H?"checked":"")});var y=new tinymce.html.Node("i",1);y.attr({contenteditable:"false"});var M=new tinymce.html.Node("#text",3);M.raw=true;M.value="&nbsp;";y.append(M);J.append(y);K.append(J);var I=new tinymce.html.Node("span",1);I.attr({contenteditable:z});if(typeof F==="string"){var B=new tinymce.html.Node("#text",3);B.raw=true;B.value=F;I.append(B)}else{var A,E=[];for(A=F.firstChild;A;A=A.walk()){if(A.parent==F){E.push(A)}if(A==F.lastChild){break}}for(var C=0;C<E.length;C++){I.append(E[C])}}K.append(I);return K}function q(y){jQuery(y).click(function(){var z=g.getParam("ffxhrevent");var B=jQuery(y);var A=B.parent("span.hottext").data("qti-identifier");o_ffXHRNFEvent(z.formNam,z.dispIdField,z.dispId,z.eventIdField,2,"_csrf",z.csrf,"cmd","hottext","identifier",A,"correct",B.hasClass("checked")?"false":"true");if(B.hasClass("checked")){B.removeClass("checked");B.parent("span.hottext").attr("data-qti-checked","false")}else{B.addClass("checked");B.parent("span.hottext").attr("data-qti-checked","true")}g.setDirty(true)})}function u(y){jQuery("a.o_ops",y).click(function(){var B=g.getParam("ffxhrevent");var A=jQuery(y).attr("data-qti-response-identifier");var z=jQuery(y).children().html();var C=(z==""||z=="&nbsp;"?"true":"false");o_ffXHREvent(B.formNam,B.dispIdField,B.dispId,B.eventIdField,2,false,false,false,"_csrf",B.csrf,"cmd","gapentry","responseIdentifier",A,"selectedText",z,"emptySolution",C);g.setDirty(true)})}function k(z){var y="";var B=new tinymce.dom.TreeWalker(z);var A;while((A=B.next())){if(A.type==3){if(y.length>0){y+=" "}y+=A.value}else{if(A.nodeType==3){if(y.length>0){y+=" "}y+=A.nodeValue}}}return y}function a(A){var y=false;var B='<div id="'+n()+'">'+A+"</div>";var C=jQuery(B);jQuery(C).find("span[data-qti='hottext']").each(function(D,F){var E="ht"+n();jQuery(F).attr("data-qti-identifier",E);jQuery(F).attr("data-copy","needlistener");jQuery(F).attr("data-copy-empty","false");var G=jQuery("span[contenteditable='true']",F).text();if(G==null||G.length==0){jQuery("span[contenteditable='true']",F).text("x-y-x");jQuery(F).attr("data-copy-empty","true")}y=true});jQuery(C).find("span[data-qti='textentryinteraction']").each(function(G,I){var H="te"+n();jQuery(I).attr("data-qti-response-identifier",H);jQuery(I).attr("data-copy","needlistener");jQuery(I).attr("data-copy-empty","false");var E=jQuery(I).attr("data-qti-gap-type");var D=jQuery(I).attr("data-qti-solution");var F=g.getParam("ffxhrevent");o_ffXHRNFEvent(F.formNam,F.dispIdField,F.dispId,F.eventIdField,2,"_csrf",F.csrf,"cmd","copy-gapentry","responseIdentifier",H,"newEntry",true,"selectedText",D,"gapType",E);jQuery("a.o_ops",I).append(jQuery("<i class='visible'>&nbsp;</i>"));var J=jQuery("span[contenteditable='true']",I).text();if(J==null||J.length==0){jQuery("span[contenteditable='true']",I).text("x-y-x");jQuery(I).attr("data-copy-empty","true")}y=true});var z=new Object();z.replace=y;z.htmlContent=C;return z}g.addCommand("qtiUpdateTextEntry",function(B,A){var z=A.responseIdentifier;var y=A["data-qti-solution"];jQuery("span[data-qti-response-identifier='"+z+"']>span",g.getBody()).each(function(C,D){jQuery(D).text(y)});jQuery("span[data-qti-response-identifier='"+z+"']",g.getBody()).each(function(C,D){u(jQuery(D))})});g.addCommand("qtiCancelTextEntry",function(z,y){g.setDirty(true)});g.on("init",function(){if(g.settings.content_css!==false){g.dom.loadCSS(f+"/css/content.css")}jQuery(".textentryinteraction",g.getBody()).each(function(y,z){u(z)});jQuery("span.hottext a.o_check",g.getBody()).each(function(y,z){q(z)})});g.on("preInit",function(){g.parser.addNodeFilter("textentryinteraction,hottext",function(y){var C=y.length,A,I,D;while(C--){A=y[C];if(A.name=="textentryinteraction"){var K=A.attr("responseidentifier");if(K.lastIndexOf("RESPONSE_",0)==0){var z=parseInt(K.substring(9,K.length));if(z>r){r=z}}var J=A.attr("openolattype");var H=A.attr("data-qti-solution");if(typeof H==="undefined"){H="&nbsp;"}if(typeof J==="undefined"){J="string"}var I=o(K,H,"textentryinteraction",J);A.replace(I)}else{if(A.name=="hottext"){var G=A.attr("identifier");var B=g.getParam("correctHottexts");var F=jQuery.inArray(G,B)>=0;var E=A;var I=v(G,E,F,"hottext","hottext");A.replace(I)}}}})});g.on("PreProcess",function(y){tinymce.each(g.dom.select("span[data-qti=textentryinteraction]"),function(B){var A=jQuery(B).attr("data-qti-response-identifier");var z=jQuery(B).children().text();var D=g.dom.create("textEntryInteraction",{responseIdentifier:A,"data-qti-solution":z,"data-qti-solution-empty":(z==""||z=="&nbsp;"?"true":"false")});var C=B.previousSibling==null&&(B.nextSibling==null||jQuery(B.nextSibling).attr("type")=="_moz"||jQuery(B.nextSibling).attr("data-mce-bogus")=="1");g.dom.replace(D,B,false);if(C){jQuery(D).after(String.fromCharCode(160))}});tinymce.each(g.dom.select("span[data-qti=hottext]"),function(C){var A=jQuery(C).data("qti-identifier");var z=g.dom.create("hottext",{identifier:A});var B=jQuery('span[contenteditable="true"]',C);jQuery(z).append(B.contents());g.dom.replace(z,C,false)})});g.on("newcell",function(z){var y=a(z.node.innerHTML);if(y.replace){z.node.innerHTML=jQuery(y.htmlContent).html()}});g.on("PastePreProcess",function(B){var z=g.selection.getNode();if(z!=null&&(jQuery(z).parent("span.hottext").length>0||jQuery(z).parent("span.textentryinteraction").length>0)){var A='<div id="'+n()+'">'+B.content+"</div>";var C=jQuery(A);B.content=jQuery(C).text();return}var y=a(B.content);if(y.replace){B.content=jQuery(y.htmlContent).html()}})}});tinymce.PluginManager.add("olatqti",org.olat.ims.qti21.ui.editor)})();