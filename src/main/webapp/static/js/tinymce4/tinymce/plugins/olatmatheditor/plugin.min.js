(function(){tinymce.create("org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor",{init:function(b,d){var f;var g=window.MathJax;function c(){if(f){return f}var h=o_getMainWin();if(h){f=jQuery(document).ooTranslator().getTranslator(h.o_info.locale,"org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor")}else{f={translate:function(i){return i}}}return f}function e(){var i=win.find("#latex")[0].value();var h=b.selection.getNode();if((h!=null)&&(/mceItemJSMath/.test(b.dom.getAttrib(h,"class")))){b.dom.setAttrib(h,"data-mathtex",i);b.dom.setAttrib(h,"data-mce-placeholder","");b.dom.setAttrib(h,"title",escape(i));b.execCommand("mceRepaint");b.setDirty(true)}else{var j='<img src="'+tinymce.Env.transparentSrc+'" class="mce-shim mceItemJSMath" data-mce-placeholder="latex" data-mathtex="'+i+'" title="'+escape(i)+'" width="32" height="32"/>';b.execCommand("mceInsertContent",false,j)}}function a(){win=b.windowManager.open({title:c().translate("olatmatheditor.formulaTabTitle"),minWidth:540,body:[{type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,items:[{type:"label",text:c().translate("olatmatheditor.latexGroupTitle")},{name:"latex",type:"textbox",multiline:true,flex:1,minHeight:120,onkeyup:h},{name:"preview",type:"panel",label:"",flex:1,minHeight:120,html:'<iframe id="mathpreviewFormula" style="width: 100%; min-height: 50px;"></iframe>'},{name:"hints",type:"panel",label:"",flex:1,minHeight:20,html:'<div style="width:100%;">'+c().translate("olatmatheditor.latexGroupHint")+"</div>"}]}],onSubmit:e});var m=document.getElementById("mathpreviewFormula");var j=m.contentWindow||m.contentDocument.document||m.contentDocument;var l=j.document;var i=l.getElementsByTagName("head")[0];var q=l.getElementsByTagName("body")[0];function h(){var s=j.MathJax;var t=q.querySelector("div");if(!t){t=l.createElement("div");t.classList.add("math");q.appendChild(t)}var r=win.find("#latex")[0].value();t.innerHTML="$$"+r+"$$";if(s&&s.startup){s.startup.getComponents();s.typeset()}}var n=b.getParam("mathJaxUrl");var k=j.document.createElement("script");k.src=n+"tex-mml-chtml.js";k.type="text/javascript";k.async=false;k.charset="utf-8";i.appendChild(k);var o=b.selection.getNode();if((o.nodeName.toLowerCase()=="img")&&(o.className.indexOf("mceItemJSMath")>=0)){var p=jQuery(o).attr("data-mathtex");win.find("#latex")[0].value(p);h()}}b.addButton("olatmatheditor",{title:c().translate("olatmatheditor.desc"),icon:"math",stateSelector:["img[data-mathtex]","span[data-mathtex]"],onclick:a,onPostRender:function(){var h=this;b.on("NodeChange",function(i){var j=(i.element.nodeName=="IMG")&&(/mceItemJSMath/.test(b.dom.getAttrib(i.element,"class")));h.active(j);if(j){i.preventDefault(true);i.stopImmediatePropagation()}})}});b.addMenuItem("olatmatheditor",{text:c().translate("olatmatheditor.desc"),icon:"math",stateSelector:["img[data-mathtex]","span[data-mathtex]"],onclick:a,context:"insert",});b.on("init",function(){if(b.settings.content_css!==false){b.dom.loadCSS(d+"/css/content.css")}});b.on("LoadContent",function(h){tinymce.each(b.dom.select("span.math"),function(j){var k=j.innerHTML;var i=b.dom.create("img",{"class":"mce-shim mceItemJSMath",width:"32",height:"32",src:tinymce.Env.transparentSrc,"data-mathtex":k,"data-mce-placeholder":"latex",title:j.title});b.dom.replace(i,j)})});b.on("PreProcess",function(h){tinymce.each(b.dom.select("img.mceItemJSMath"),function(j){var i=b.dom.create("span",{"class":"math",title:j.title},jQuery(j).attr("data-mathtex"));b.dom.replace(i,j)})})},createControl:function(b,a){return null},getInfo:function(){return{longname:"OpenOLAT Math Editor",author:"frentix GmbH",authorurl:"http://www.frentix.com",infourl:"http://www.frentix.com",version:"1.3.1"}}});tinymce.PluginManager.add("olatmatheditor",org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor)})();