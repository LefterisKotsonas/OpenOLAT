#set($readOnlyClass = "")
#if($isReadOnly)
	#set($readOnlyClass = "o_read_only_container")
#end
<div id="$r.getCId()" class="o_page_run_gallery $blockLayoutClass $readOnlyClass">
	#set($bottomPaddingClass = "")
	#if($showPagination)
		#set($bottomPaddingClass = "o_bottom_padding_for_pagination")
	#end
	#set($swiperWrapperClass = "")
	#if($gridMode)
		#set($swiperWrapperClass = "o_swiper_wrapper")
		#set($bottomPaddingClass = "")
	#end
	<div class="o_gallery_header">
		<div class="o_gallery_title">$r.escapeHtml($title)</div>
		#if($showTopNavButtons)
		<div class="o_gallery_buttons">
			<div id="o_swiper_button_prev_$r.getCId()" class="swiper-button-prev"></div>
			<div id="o_swiper_button_next_$r.getCId()" class="swiper-button-next"></div>
		</div>
		#end
	</div>
	#if($showSideNavButtons)
	<div class="o_gallery_images_with_side_nav">
	<div id="o_swiper_button_prev_$r.getCId()" class="swiper-button-prev"></div>
	#end
	<div id="o_swiper_$r.getCId()" class="swiper o_gallery_images">
		<div class="swiper-wrapper $swiperWrapperClass">
			#foreach($galleryImageItem in $galleryImageItems)
				<div class="swiper-slide $bottomPaddingClass">
					<img src="$mapperUrl/${galleryImageItem.id()}">
					#if($showTitleAndDescription)
					<div class="o_title_and_description">
						<div class="o_title">
							$galleryImageItem.title()
						</div>
						<div class="o_description">
							$galleryImageItem.description()
						</div>
					</div>
					#end
				</div>
			#end
		</div>
		<div class="swiper-button-prev"></div>
		<div class="swiper-button-next"></div>
		<div class="swiper-pagination"></div>
	</div>
	#if($showSideNavButtons)
	<div id="o_swiper_button_next_$r.getCId()" class="swiper-button-next"></div>
	</div>
	#end
	#if($showThumbnails)
	<div id="o_swiper_thumbs_$r.getCId()" class="swiper o_gallery_thumbs">
		<div class="swiper-wrapper">
			#foreach($galleryImageItem in $galleryImageItems)
			<div class="swiper-slide">
				<img src="$mapperUrl/${galleryImageItem.id()}">
			</div>
			#end
		</div>
	</div>
	#end
	#if($isReadOnly)
	<div class="o_read_only_layer"></div>
	#end
</div>
<script>
	"use strict";
	var imageGallery = new Swiper('#o_swiper_$r.getCId()', {
		grid: {
			rows: $rows,
		},
		slidesPerView: $columns,
		spaceBetween: 10,
		breakpointBase: 'container',
		navigation: {
			prevEl: '#o_swiper_button_prev_$r.getCId()',
			nextEl: '#o_swiper_button_next_$r.getCId()',
			disabledClass: 'o_swiper_button_disabled'
		},
		#if($showPagination)
		pagination: {
			el: '.swiper-pagination',
			clickable: true
		},
		#end
	});

	#if($showThumbnails)
	var thumbsGallery = new Swiper('#o_swiper_thumbs_$r.getCId()', {
		centeredSlides: true,
		spaceBetween: 10,
		slidesPerView: 'auto',
		slideToClickedSlide: true,
		touchRatio: 0.2,
	});

	imageGallery.controller.control = thumbsGallery;
	thumbsGallery.controller.control = imageGallery;
	#end

	#if($gridMode)
	var maxHeightPerRow = new Array($rows).fill(0);
	jQuery(function() {
		var swiperSlide = jQuery('#o_swiper_$r.getCId() .swiper-slide');
		swiperSlide.each(function(i, obj) {
			var rowIndex = i % $rows;
			var height = obj.clientHeight;
			maxHeightPerRow[rowIndex] = Math.max(height, maxHeightPerRow[rowIndex]);
		});
		var totalHeight = 0;
		for (var row = 0; row < $rows; row++) {
			totalHeight += maxHeightPerRow[row];
		}
		totalHeight += 40 + 10 * ($rows - 1);

		var swiper = document.getElementById('o_swiper_$r.getCId()');
		swiper.setAttribute('style', `height: ${totalHeight}px;`);

		setTimeout(function() {
			swiperSlide.each(function(i, obj) {
				var rowIndex = i % $rows;
				var height = maxHeightPerRow[rowIndex];
				obj.style.height = `${height}px`;
				obj.style.marginTop = '0';
				if (rowIndex < ($rows - 1)) {
					obj.style.marginBottom = '10px';
				}
			});
		}, 500);
	});
	#end
</script>