<div class="o_page_run_code">
	<pre><code id="$r.getCId()_code"
			   class="#if($codeLanguage) language-$codeLanguage #end #if($lineNumbersEnabled) o_line_numbers_enabled #end"
			   #if($height && !$expanded) style="height: $height; overflow: auto;" #end>$content</code></pre>
	#if($height && !$expanded)<div class="o_top_overlay"></div>#end
	<div id="$r.getCId()_overlay" class="o_button_overlay"></div>
	#if($height && !$expanded)<div id="$r.getCId()_bottom_overlay" class="o_bottom_overlay"></div>#end
	<script>
		"use strict";
		function copyToClipboard(selector, lineNumbersEnabled) {
			if (lineNumbersEnabled) {
				copyToClipboardWithLineNumbers(selector);
			} else {
				copyToClipboardWithoutLineNumbers(selector);
			}
		}

		function copyToClipboardWithLineNumbers(selector) {
			const tableRows = jQuery(`${selector} tr`);
			let targetText = '';
			for (let i = 0; i < tableRows.length; i++) {
				const line = jQuery(tableRows.get(i)).text();
				targetText += `${line}\n`;
			}
			navigator.clipboard.writeText(targetText);
		}

		function copyToClipboardWithoutLineNumbers(selector) {
			navigator.clipboard.writeText(jQuery(selector).text() + '\n');
		}

		function codeCopiedNotification(anchorDiv) {
			anchorDiv.title = '$r.translate("code.copied")';
			const anchor = jQuery(anchorDiv);
			const icon = anchor.find('i.o_icon');
			icon.removeClass('o_icon_copy');
			icon.addClass('o_icon_check');
			setTimeout(() => {
				anchorDiv.title = '$r.translate("code.copy.to.clipboard")';
				icon.removeClass('o_icon_check');
				icon.addClass('o_icon_copy');
			}, 2000);
		}

		function adjustToScrollbars(codeElement, overlayElement, bottomOverlayElement) {
			const verticalScrollbarVisible = codeElement.scrollHeight > codeElement.clientHeight;
			if (verticalScrollbarVisible) {
				let div = document.createElement('div');
				div.style.overflowY = 'scroll';
				div.style.width = '50px';
				div.style.height = '50px';
				document.body.append(div);
				let scrollWidth = div.offsetWidth - div.clientWidth;
				div.remove();
				overlayElement.style.borderRightWidth = 0;
				overlayElement.style.borderTopRightRadius = 0;
				let borderCorrection = 4 - 1; // wrapping <pre>'s (borderRadius - borderWidth)
				let right = scrollWidth + borderCorrection;
				overlayElement.style.right = `${right}px`;
			}

			const horizontalScrollbarVisible = codeElement.scrollWidth > codeElement.clientWidth;
			if (horizontalScrollbarVisible) {
				const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
				if (isSafari) {
					codeElement.style.overflowX = 'scroll';
				}
				if (bottomOverlayElement) {
					bottomOverlayElement.style.display = 'none';
				}
			}
		}

		jQuery(function() {
			const codeElement = document.getElementById('$r.getCId()_code');
			const overlayElement = document.getElementById('$r.getCId()_overlay');
			const bottomOverlayElement = document.getElementById('$r.getCId()_bottom_overlay');
			hljs.highlightElement(codeElement);
			#if($lineNumbersEnabled)
				hljs.lineNumbersBlock(codeElement);
			#end
			const cssClasses = Array.from(codeElement.classList).filter((c) => c.startsWith('language-'));
			if (cssClasses.length > 0) {
				const languageClassParts = cssClasses[0].split('-');
				if (languageClassParts.length > 1) {
					const languageName = languageClassParts[1];
					let languageLabel = languageName;
					if (languageName === 'plaintext') {
						languageLabel = '$r.translate("code.plaintext")';
					}
					overlayElement.innerHTML =
						'<a href="javascript:;" ' +
						'   title="$r.translate('code.copy.to.clipboard')" ' +
						'   onclick="copyToClipboard(\'#$r.getCId()_code\', $lineNumbersEnabled); codeCopiedNotification(this); this.blur();">' +
						'  <i class="o_icon o_icon_copy"> </i> ' + languageLabel + '</a>';
				}
			}
			setTimeout(function() {
				adjustToScrollbars(codeElement, overlayElement, bottomOverlayElement);
			}, 0);
		});
	</script>
</div>
#if($height && $allowExpand)
<div class="o_page_run_code_expand o_expand_ctrl">
	<div class="o_button_group">
		$r.render("expandCollapseButton")
	</div>
</div>
#end
