$r.render("timelineEvents")

#if ($f.hasError("timelineEvents"))
	$r.render("timelineEvents_ERROR")
#end

<style>
</style>

#if ($showPlayHead)
<div id="o_video_play_head">
	<div class="o_video_play_head_marker">
		<i class='o_icon o_icon-lg o_icon_caret o_video_play_head_marker_icon'></i>
	</div>
	<div class="o_video_play_head_text">
		00:00:00
	</div>
</div>
#end

<script>
	function scrollHandler() {
		timeUpdateListener();
	}

	function initPlayHead() {
		const playHead = jQuery('#o_video_play_head');
		const videoChannels = jQuery('.o_video_channels');
		if (playHead && videoChannels) {
			const videoChannelsOffset = videoChannels.offset();
			if (videoChannelsOffset) {
				const playHeadLeft = videoChannelsOffset.left;
				const playHeadTop = videoChannelsOffset.top - 10;
				const playHeadHeight = videoChannels.height() + 20;
				playHead.offset({left: playHeadLeft - 1, top: playHeadTop});
				playHead.height(playHeadHeight);

				const videoElementId = 'o_so_vid$videoElementId';
				const videoElement = jQuery('#' + videoElementId);
				const player = videoElement.data('player');
				player.media.removeEventListener(timeUpdateListener);
				player.media.addEventListener('timeupdate', timeUpdateListener);
			}
			videoChannels.scroll(scrollHandler);
		}
	}

	function formatTime(sec) {
		const hours = Math.floor(sec / 3600);
		const minutes = Math.floor((sec - (hours * 3600)) / 60);
		const seconds = Math.floor(sec - (hours * 3600) - (minutes * 60));

		let timeString = '';
		if (hours < 10) {
			timeString += '0' + hours + ':';
		} else {
			timeString += hours + ':';
		}
		if (minutes < 10) {
			timeString += '0';
		}
		timeString += minutes + ':';

		if (seconds < 10) {
			timeString += '0' + seconds;
		} else {
			timeString += seconds;
		}

		return timeString;
	}

	function timeUpdateListener() {
		const playHead = jQuery('#o_video_play_head');
		const videoChannels = jQuery('.o_video_channels');
		const playHeadText = jQuery('.o_video_play_head_text');
		const videoElementId = 'o_so_vid$videoElementId';
		const videoElement = jQuery('#' + videoElementId);
		const player = videoElement.data('player');
		const currentTimeInSeconds = player.media.currentTime;
		const durationInSeconds = player.media.duration;
		const videoChannelsOffset = videoChannels.offset();
		const videoChannelsWidth = videoChannels.get(0).scrollWidth;
		const videoChannelsViewportWidth = videoChannels.width();
		const videoChannelsScrollLeft = videoChannels.scrollLeft();
		const playHeadTop = playHead.offset().top;
		const playHeadLeft = videoChannelsOffset.left + currentTimeInSeconds * videoChannelsWidth / durationInSeconds - videoChannelsScrollLeft;
		const playHeadVisible = (playHeadLeft >= videoChannelsOffset.left && playHeadLeft <= (videoChannelsOffset.left + videoChannelsViewportWidth));
		playHeadText.text(formatTime(currentTimeInSeconds));
		if (playHeadVisible) {
			playHead.css({ 'opacity' : 1 });
			playHeadText.show();
		} else {
			playHead.css({ 'opacity' : 0 });
			playHeadText.hide();
		}
		playHead.offset({left: playHeadLeft - 1, top: playHeadTop});

	}

	initPlayHead();
</script>