<style>
	.o_video_apply_position_timestamp input {
		width: 80px;
		border-top-right-radius: 0;
		border-bottom-right-radius: 0;
	}

	.o_video_grid_container {
		display: grid;
		grid-template-columns: 130px 120px 10px 120px 130px 120px;
		grid-template-rows: auto;
		grid-template-areas:
		"se-label start   dash  end   duration-label duration"
		"pad1     e-start pad2  e-end pad3           e-duration"
		"ca-label ca      ca    ca    ca             ca"
		"pad5     ca-ed   ca-ed ca-ed ca-ed          ca-ed"
		"pad5     b       b     b     b              b"
		;
	}

	.o_video_grid_item_se_label {
		grid-area: se-label;
		justify-self: right;
		margin-right: 5px;
	}

	.o_video_grid_item_start {
		grid-area: start;
		justify-self: left;
	}
	.o_video_grid_item_error_start {
		grid-area: e-start;
		justify-self: left;
	}

	.o_video_grid_item_dash {
		grid-area: dash;
		justify-self: center;
	}

	.o_video_grid_item_end {
		grid-area: end;
		justify-self: right;
	}

	.o_video_grid_item_error_end {
		grid-area: e-end;
		justify-self: left;
	}

	.o_video_grid_item_error_start_end {
		grid-area: 2 / 2 / 3 / 5;
		justify-self: left;
	}

	.o_video_grid_item_duration_label {
		grid-area: duration-label;
		justify-self: right;
		margin-right: 5px;
	}

	.o_video_grid_item_duration {
		grid-area: duration;
		justify-self: stretch;
	}

	.o_video_grid_item_error_duration {
		grid-area: e-duration;
		justify-self: stretch;
	}

	.o_video_grid_item_category_label {
		grid-area: ca-label;
		justify-self: right;
		margin-right: 5px;
		margin-top: 10px;
	}

	.o_video_grid_item_category_button {
		grid-area: ca;
		justify-self: stretch;
		margin-top: 10px;
	}

	.o_video_grid_item_category_edit {
		grid-area: ca-ed;
		justify-self: stretch;
		margin-top: 5px;
	}

	.o_video_grid_item_buttons {
		grid-area: b;
		justify-self: left;
		margin-top: 10px;
	}

</style>

<div class="form-group row clearfix">

	<div class="o_video_grid_container">
		<div class="o_video_grid_item_se_label">$r.render("start", "label")</div>

		<div class="o_video_grid_item_start btn-group">
			<div class="btn-group o_video_apply_position_timestamp o_video_segment_start" style="display: inline-block;">$r.render("start")</div>
			<div class="btn-group o_video_apply_position_button" style="display: inline-block;">$r.render("startApplyPosition")</div>
		</div>

		#if ($f.hasError("start"))
		<div class="o_video_grid_item_error_start">$r.render("start", "error")</div>
		#end

		<div class="o_video_grid_item_dash" style="display: inline-block; text-align: center; line-height: 32px;">-</div>

		<div class="o_video_grid_item_end btn-group">
			<div class="btn-group o_video_apply_position_timestamp o_video_segment_end" style="display: inline-block;">$r.render("end")</div>
			<div class="btn-group o_video_apply_position_button" style="display: inline-block;">$r.render("endApplyPosition")</div>
		</div>

		#if ($f.hasError("end"))
		<div class="o_video_grid_item_error_end">$r.render("end", "error")</div>
		#end

		#if ($overlapError)
		<div class="o_video_grid_item_error_start_end o_error">$r.translate("form.segment.error.overlap")</div>
		#end

		<div class="o_video_grid_item_duration_label">$r.render("duration", "label")</div>

		<div class="o_video_grid_item_duration o_video_segment_duration">$r.render("duration")</div>

		#if ($f.hasError("duration"))
		<div class="o_video_grid_item_error_duration">$r.render("duration", "error")</div>
		#else
		<div class="o_video_grid_item_error_duration o_form_example help-block">$r.render("duration", "example")</div>
		#end

		<div class="o_video_grid_item_category_label">$r.render("category", "label")</div>
		<div class="o_video_grid_item_category_button">$r.render("category")</div>

		#if ($categoryOpen)
		<div class="o_video_grid_item_category_edit">
			<div class="o_categories">
				#if ($categoriesAvailable)
				<ul class="o_category_list">
					#foreach ($category in $categories)
					#set ( $selectedClass = "#if ($category.getId() == $categoryId) o_selected#{else} #end" )
					<li class="o_category_list_item $selectedClass" onclick="$f.ffXHREvent('categoryId', $category.getId())">
						<div class="o_video_colored_area o_color_cube ${category.getColor()}"></div>
						<div class="o_category_text">${category.getLabelAndTitle()} (${categoryUsedCounts.get($category.getId())})</div>
					</li>
					#end
				</ul>
				#else
				<span class="o_video_segment_category_placeholder">$r.translate("form.segment.noCategoryAvailableYet")</span>
				#end
				<div class="o_edit_categories">
					$r.render("editCategories")
				</div>
			</div>
		</div>
		#end
		<div class="o_video_grid_item_buttons">$r.render("save") $r.render("cancel")</div>
	</div>
</div>

<script>
	jQuery(() => {
		const start = jQuery('.o_video_segment_start input');
		const end = jQuery('.o_video_segment_end input');
		const duration = jQuery('.o_video_segment_duration input');

		const parseTimeToSeconds = (timeString) => {
			const parts = timeString.split(':');
			return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
		}

		const formatTime = (timeInSec, defaultTimeString) => {
			if (timeInSec <= 0) {
				return defaultTimeString;
			}
			return new Date(timeInSec * 1000).toISOString().substring(11, 19);
		}

		const updateDuration = () => {
			const startInSec = parseTimeToSeconds(start.val());
			const endInSec = parseTimeToSeconds(end.val());

			if (endInSec - startInSec > 0) {
				duration.val((endInSec - startInSec));
			}
		};

		const updateEnd = () => {
			const startInSec = parseTimeToSeconds(start.val());
			const durationInSec = parseInt(duration.val());
			const endTimeString = formatTime(startInSec + durationInSec, end.val());
			end.val(endTimeString);
		}

		start.on('keyup', updateDuration);
		end.on('keyup', updateDuration);
		duration.on('keyup', updateEnd);
	});
</script>